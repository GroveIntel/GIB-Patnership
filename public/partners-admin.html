<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>GIB Partner Program Admin</title>

    <link rel="stylesheet" href="/css/partners.css" />
    <link rel="icon" type="image/png" href="/Assets/img_header_logo.png" />

    <style>
        .admin-wrapper {
            padding: 2.5rem 0;
        }

        .admin-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 1.5rem;
            gap: 1.5rem;
        }

        .admin-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            background: #ffffff;
            border-radius: 0.75rem;
            overflow: hidden;
            border: 1px solid var(--color-border);
        }

        .admin-table th,
        .admin-table td {
            padding: 0.65rem 0.75rem;
            border-bottom: 1px solid #eceff1;
            text-align: left;
            vertical-align: top;
        }

        .admin-table th {
            background: #f5f5f5;
            font-weight: 600;
            font-size: 0.85rem;
        }

        .admin-table tbody tr:last-child td {
            border-bottom: none;
        }

        .badge-pending {
            display: inline-block;
            padding: 0.15rem 0.5rem;
            border-radius: 999px;
            font-size: 0.75rem;
            background: #fff3e0;
            color: #e65100;
        }

        .admin-actions {
            display: flex;
            gap: 0.5rem;
            flex-wrap: wrap;
        }

        .btn-secondary {
            display: inline-block;
            padding: 0.4rem 0.9rem;
            border-radius: 999px;
            border: 1px solid var(--color-border);
            background: #ffffff;
            font-size: 0.8rem;
            cursor: pointer;
        }

        .btn-secondary.danger {
            border-color: #e53935;
            color: #e53935;
        }

        .admin-note {
            font-size: 0.85rem;
            color: #666;
            margin-top: 0.75rem;
        }

        .admin-empty {
            margin-top: 2rem;
            font-size: 0.9rem;
            color: #666;
        }

        .admin-auth {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            background: #ffffff;
            padding: 0.5rem 0.75rem;
            border-radius: 999px;
            border: 1px solid var(--color-border);
        }

        #admin-token-input {
            border: none;
            outline: none;
            font-size: 0.85rem;
            min-width: 180px;
        }

        .admin-tabs {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        .admin-tab {
            padding: 0.4rem 0.9rem;
            border-radius: 999px;
            border: 1px solid transparent;
            background: transparent;
            font-size: 0.85rem;
            cursor: pointer;
        }

        .admin-tab.active {
            background: #ffffff;
            border-color: var(--color-primary);
            color: var(--color-primary);
            font-weight: 600;
        }

        .reject-modal-backdrop {
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.4);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
        }

        .reject-modal {
            background: #ffffff;
            border-radius: 0.75rem;
            padding: 1.5rem;
            max-width: 420px;
            width: 100%;
            box-shadow: 0 18px 40px rgba(15, 23, 42, 0.22);
            border: 1px solid var(--color-border);
        }

        .reject-modal h2 {
            margin-top: 0;
            margin-bottom: 0.5rem;
            font-size: 1.1rem;
        }

        .reject-modal p {
            font-size: 0.9rem;
            margin-top: 0;
            margin-bottom: 0.75rem;
        }

        .reject-modal textarea {
            width: 100%;
            min-height: 80px;
            resize: vertical;
            padding: 0.6rem 0.7rem;
            font-family: inherit;
            font-size: 0.9rem;
            border-radius: 0.5rem;
            border: 1px solid var(--color-border);
        }

        .reject-modal-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.5rem;
            margin-top: 0.9rem;
        }

        .admin-filters {
            display: flex;
            flex-wrap: wrap;
            gap: 0.5rem;
            margin-bottom: 0.75rem;
            font-size: 0.85rem;
        }

        .admin-filters input {
            padding: 0.4rem 0.6rem;
            border-radius: 999px;
            border: 1px solid var(--color-border);
            font-size: 0.85rem;
        }

        .danger-text {
            color: #e53935;
            font-weight: 600;
        }
    </style>
</head>

<body>
    <header class="site-header">
        <div class="container header-inner">
            <a href="https://groveintel.com" class="logo-link">
                <img src="/Assets/img_header_logo.png" alt="Grove Intelligence Bureau" class="logo-image" />
            </a>
            <nav class="nav-links">
                <a href="/partners">Back to Partner Page</a>
            </nav>
        </div>
    </header>

    <main class="section-light">
        <div class="container admin-wrapper">
            <div class="admin-header">
                <div>
                    <h1>Partner Program Admin</h1>
                    <p class="admin-note">
                        Secure internal view of GIB Partners and earnings created via Stripe subscriptions
                        and synced from Tapfiliate.
                    </p>
                </div>

                <div class="admin-auth" id="admin-auth">
                    <input type="password" id="admin-token-input" placeholder="Admin token" />
                    <button class="btn-secondary" type="button" id="admin-signin-btn">Sign in</button>
                </div>
            </div>

            <div class="admin-tabs" id="admin-tabs" style="display:none;">
                <button type="button" class="admin-tab active" data-status="partners">Partners</button>
                <button type="button" class="admin-tab" data-status="earnings">Earnings</button>
                <button type="button" class="admin-tab" data-status="logs">Logs</button>
                <button class="btn-secondary" type="button" id="refresh-btn">Refresh</button>
                <button class="btn-secondary" type="button" id="sync-earnings-btn">Sync earnings</button>
            </div>

            <div class="admin-filters" id="admin-filters" style="display:none;">
                <input type="text" id="filter-email" placeholder="Filter by email" />
                <input type="text" id="filter-country" placeholder="Filter by country" />
                <input type="month" id="filter-period" placeholder="Filter by period" />
            </div>

            <div id="admin-table-wrapper"></div>
            <p id="admin-message" class="form-message"></p>
        </div>
    </main>

    <footer class="site-footer">
        <div class="container footer-inner">
            <p>&copy; <span id="year"></span> Grove Intelligence Bureau. All rights reserved.</p>
        </div>
    </footer>

    <script>
        document.getElementById('year').textContent = new Date().getFullYear();
        const API_BASE = '/api';
        const tableWrapper = document.getElementById('admin-table-wrapper');
        const messageEl = document.getElementById('admin-message');
        const refreshBtn = document.getElementById('refresh-btn');
        const syncEarningsBtn = document.getElementById('sync-earnings-btn');
        const adminAuth = document.getElementById('admin-auth');
        const adminTabs = document.getElementById('admin-tabs');
        const adminTokenInput = document.getElementById('admin-token-input');
        const adminSigninBtn = document.getElementById('admin-signin-btn');
        const tabs = document.querySelectorAll('.admin-tab');
        const filtersBar = document.getElementById('admin-filters');
        const filterEmailInput = document.getElementById('filter-email');
        const filterCountryInput = document.getElementById('filter-country');
        const filterPeriodInput = document.getElementById('filter-period');

        let currentStatus = 'partners';

        let adminToken = '';

        function showToast(message, type = 'info') {
            messageEl.textContent = message;
            messageEl.className = 'form-message ' + (type === 'error' ? 'error' : type === 'success' ? 'success' : '');
        }

        function setAdminUIAuthenticated(isAuthed) {
            if (isAuthed) {
                adminAuth.style.display = 'none';
                adminTabs.style.display = 'flex';
            } else {
                adminAuth.style.display = 'flex';
                adminTabs.style.display = 'none';
                filtersBar.style.display = 'none';
                tableWrapper.innerHTML = '';
            }
        }

        async function apiFetch(path, options = {}) {
            const headers = options.headers || {};
            headers['Authorization'] = `Bearer ${adminToken}`;
            headers['Content-Type'] = headers['Content-Type'] || 'application/json';

            const res = await fetch(`${API_BASE}${path}`, { ...options, headers });

            if (res.status === 401) {
                setAdminUIAuthenticated(false);
                throw new Error('Unauthorized. Check your admin token.');
            }

            const data = await res.json();
            if (!data.success) {
                throw new Error(data.message || 'Request failed');
            }

            return data;
        }

        async function loadApplications() {
            messageEl.textContent = '';
            tableWrapper.innerHTML = '<p class="admin-note">Loading data...</p>';

            try {
                if (currentStatus === 'partners') {
                    const data = await apiFetch('/partners');
                    const partners = data.partners || [];

                    if (partners.length === 0) {
                        tableWrapper.innerHTML = '<p class="admin-empty">No partners yet.</p>';
                        filtersBar.style.display = 'none';
                        return;
                    }

                    filtersBar.style.display = 'flex';

                    const emailFilter = filterEmailInput.value.trim().toLowerCase();
                    const countryFilter = filterCountryInput.value.trim().toLowerCase();

                    const filtered = partners.filter(p => {
                        const email = (p.email || '').toLowerCase();
                        const country = (p.country || '').toLowerCase();
                        const emailMatch = emailFilter ? email.includes(emailFilter) : true;
                        const countryMatch = countryFilter ? country.includes(countryFilter) : true;
                        return emailMatch && countryMatch;
                    });

                    if (filtered.length === 0) {
                        tableWrapper.innerHTML = '<p class="admin-empty">No partners match these filters.</p>';
                        return;
                    }

                    const rows = filtered.map(p => {
                        const created = p.created_at ? new Date(p.created_at).toLocaleString() : '';
                        return `
                          <tr>
                            <td>${p.id}</td>
                            <td>${p.name || ''}<br /><span style="font-size:0.8rem;color:#666;">${p.email || ''}</span></td>
                            <td>${p.country || ''}</td>
                            <td>${p.tier || ''}</td>
                            <td>${created}</td>
                          </tr>
                        `;
                    }).join('');

                    tableWrapper.innerHTML = `
                      <table class="admin-table">
                        <thead>
                          <tr>
                            <th>ID</th>
                            <th>Name / Email</th>
                            <th>Country</th>
                            <th>Tier</th>
                            <th>Created</th>
                          </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                      </table>
                    `;

                    return;
                }

                if (currentStatus === 'earnings') {
                    const selectedPeriod = (filterPeriodInput && filterPeriodInput.value)
                        ? filterPeriodInput.value
                        : new Date().toISOString().slice(0, 7);

                    const data = await apiFetch(`/partner-earnings?period=${encodeURIComponent(selectedPeriod)}`);
                    const earnings = data.earnings || [];

                    if (earnings.length === 0) {
                        tableWrapper.innerHTML = '<p class="admin-empty">No earnings found for this period.</p>';
                        filtersBar.style.display = 'none';
                        return;
                    }

                    filtersBar.style.display = 'flex';

                    const emailFilter = filterEmailInput.value.trim().toLowerCase();
                    const countryFilter = filterCountryInput.value.trim().toLowerCase();

                    const filtered = earnings.filter(e => {
                        const email = (e.email || '').toLowerCase();
                        const country = (e.country || '').toLowerCase();
                        const emailMatch = emailFilter ? email.includes(emailFilter) : true;
                        const countryMatch = countryFilter ? country.includes(countryFilter) : true;
                        return emailMatch && countryMatch;
                    });

                    if (filtered.length === 0) {
                        tableWrapper.innerHTML = '<p class="admin-empty">No earnings match these filters.</p>';
                        return;
                    }

                    const totals = filtered.reduce((acc, e) => {
                        const gross = Number(e.gross_revenue || 0);
                        const net = Number(e.net_revenue || 0);
                        const commission = Number(e.commission_amount || 0);
                        acc.gross += Number.isNaN(gross) ? 0 : gross;
                        acc.net += Number.isNaN(net) ? 0 : net;
                        acc.commission += Number.isNaN(commission) ? 0 : commission;
                        return acc;
                    }, { gross: 0, net: 0, commission: 0 });

                    const rows = filtered.map(e => {
                        const period = e.period ? new Date(e.period).toLocaleDateString() : '';
                        const ratePct = e.commission_rate != null
                            ? (Number(e.commission_rate) * 100).toFixed(1) + '%'
                            : '';
                        return `
                          <tr>
                            <td>${e.id}</td>
                            <td>${e.name || ''}<br /><span style="font-size:0.8rem;color:#666;">${e.email || ''}</span></td>
                            <td>${e.country || ''}</td>
                            <td>${period}</td>
                            <td>${e.currency || ''}</td>
                            <td>${e.gross_revenue}</td>
                            <td>${e.net_revenue}</td>
                            <td>${ratePct}</td>
                            <td>${e.commission_amount}</td>
                          </tr>
                        `;
                    }).join('');

                    tableWrapper.innerHTML = `
                      <p class="admin-note">Period totals â€“ Gross: ${totals.gross.toFixed(2)}, Net: ${totals.net.toFixed(2)}, Commissions: ${totals.commission.toFixed(2)}</p>
                      <table class="admin-table">
                        <thead>
                          <tr>
                            <th>ID</th>
                            <th>Name / Email</th>
                            <th>Country</th>
                            <th>Period</th>
                            <th>Currency</th>
                            <th>Gross</th>
                            <th>Net (after fees)</th>
                            <th>Rate</th>
                            <th>Commission</th>
                          </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                      </table>
                    `;

                    return;
                }

                if (currentStatus === 'logs') {
                    const data = await apiFetch('/admin-logs');
                    const logs = data.logs || [];

                    if (logs.length === 0) {
                        tableWrapper.innerHTML = '<p class="admin-empty">No admin logs yet.</p>';
                        filtersBar.style.display = 'none';
                        return;
                    }

                    filtersBar.style.display = 'none';

                    const rows = logs.map(log => {
                        const when = new Date(log.created_at).toLocaleString();
                        return `
                          <tr>
                            <td>${log.id}</td>
                            <td>${when}</td>
                            <td>${log.admin_identifier || ''}</td>
                            <td>${log.action}</td>
                            <td>${log.application_id || ''}</td>
                            <td>${log.details || ''}</td>
                          </tr>
                        `;
                    }).join('');

                    tableWrapper.innerHTML = `
                      <table class="admin-table">
                        <thead>
                          <tr>
                            <th>ID</th>
                            <th>When</th>
                            <th>Admin</th>
                            <th>Action</th>
                            <th>Application ID</th>
                            <th>Details</th>
                          </tr>
                        </thead>
                        <tbody>${rows}</tbody>
                      </table>
                    `;
                    return;
                }
            } catch (err) {
                showToast(err.message || 'Error loading applications.', 'error');
                tableWrapper.innerHTML = '';
            }
        }

        function setActiveTab(status) {
            currentStatus = status;
            tabs.forEach(tab => {
                tab.classList.toggle('active', tab.getAttribute('data-status') === status);
            });
            if (status === 'partners' || status === 'earnings') {
                filtersBar.style.display = 'flex';
            } else {
                filtersBar.style.display = 'none';
            }
            loadApplications();
        }

        adminSigninBtn.addEventListener('click', () => {
            const token = adminTokenInput.value.trim();
            if (!token) {
                showToast('Please enter admin token.', 'error');

                return;
            }

            adminToken = token;
            setAdminUIAuthenticated(true);
            showToast('Admin session active.', 'success');
            setActiveTab('partners');
        });

        tabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const status = tab.getAttribute('data-status');
                setActiveTab(status);
            });
        });

        syncEarningsBtn.addEventListener('click', async () => {
            if (currentStatus !== 'earnings') {
                showToast('Switch to the Earnings tab to sync.', 'info');
                return;
            }

            const selectedPeriod = (filterPeriodInput && filterPeriodInput.value)
                ? filterPeriodInput.value
                : new Date().toISOString().slice(0, 7);

            syncEarningsBtn.disabled = true;

            try {
                await apiFetch('/partner-earnings/sync', {
                    method: 'POST',
                    body: JSON.stringify({ period: selectedPeriod })
                });

                showToast('Earnings synced for ' + selectedPeriod + '.', 'success');
                loadApplications();
            } catch (err) {
                showToast(err.message || 'Error syncing earnings.', 'error');
            } finally {
                syncEarningsBtn.disabled = false;
            }
        });

        filterEmailInput.addEventListener('input', () => {
            if (adminTabs.style.display === 'flex') {
                loadApplications();
            }
        });

        filterCountryInput.addEventListener('input', () => {
            if (adminTabs.style.display === 'flex') {
                loadApplications();
            }
        });

        if (filterPeriodInput) {
            filterPeriodInput.value = new Date().toISOString().slice(0, 7);
            filterPeriodInput.addEventListener('change', () => {
                if (adminTabs.style.display === 'flex' && currentStatus === 'earnings') {
                    loadApplications();
                }
            });
        }

        refreshBtn.addEventListener('click', loadApplications);
        setAdminUIAuthenticated(false);
    </script>
</body>

</html>
